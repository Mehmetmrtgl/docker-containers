# Kalibr (Camera & IMU Calibration)

This module provides an automated environment for calibrating Visual-Inertial Systems (VINS). It handles both Camera Intrinsic/Extrinsic calibration and IMU-Camera Spatial/Temporal calibration using the ETHz Kalibr toolbox.
## Internal Structure

```Plaintext

kalibr/
├── data/
│   └── static_imu/        
│       └── imu.yaml       # Noise parameters (Output from allan_variance_ros)
├── script/
│   ├── cam.sh             # Camera-only calibration automation
│   └── imu_cam.sh         # IMU-Camera calibration automation
├── april_6x6_80x80cm.yaml # Target configuration
├── Dockerfile
└── kalibr.md
```

## Prerequisites

    IMU Noise Parameters: You must have the imu.yaml file generated by the allan_variance_ros module.

    Calibration Target: A printed AprilGrid. The default config is april_6x6_80x80cm.yaml (6x6 tags, 80cm width).

    Data Recording:

        Static Bag: For camera calibration (slow motion, covering all corners).

        Dynamic Bag: For IMU-Camera calibration (excitation of all axes).

## Build & Run
1. Build the Container
   
```Bash
docker compose build kalibr
```
2. Start the Environment
   
```Bash
docker compose up -d kalibr
docker exec -it kalibr_container bash
```
## Workflow
### Step 0: Configuration Setup

Before running scripts, ensure your noise parameters are correct.

1. Update IMU Config: Copy the results from allan_variance_ros into kalibr/data/static_imu/imu.yaml. It should look like this:
```YAML

# data/static_imu/imu.yaml
accelerometers:
  noise_density: 1.86e-03   # Derived from Allan Variance
  random_walk:   4.33e-04   # Derived from Allan Variance
gyroscopes:
  noise_density: 1.87e-04
  random_walk:   2.66e-05
rostopic: /imu/data         # Ensure this matches your bag topic
update_rate: 100.0
```
2. Check Target Config: If you use a different board, edit april_6x6_80x80cm.yaml inside the container to match your printed dimensions.

### Step 1: Camera Calibration (cam.sh)

Calculates lens distortion and intrinsics.

    Input: Bag file with stereo images.

    Output: Generates static-camchain.yaml.

```Bash

# Syntax: ./script/cam.sh <full_path_to_bag>
cd /root/catkin_ws
./script/cam.sh /root/catkin_ws/data/ros1bag/static_data.bag
```
### Step 2: IMU-Camera Calibration (imu_cam.sh)

Calculates the transformation (T_ic) and time offset between Camera and IMU.

    Input: Dynamic bag file + imu.yaml + static-camchain.yaml (from Step 1).

    Output: Generates dynamic-results.txt and dynamic.yaml.

```Bash

# Syntax: ./script/imu_cam.sh <full_path_to_bag>
cd /root/catkin_ws
./script/imu_cam.sh /root/catkin_ws/data/ros1bag/dynamic_data.bag
```
Note: This script automatically looks for the latest calibration_X folder created by Step 1 to find the camera chain.
## Results & Visualization

Results are saved in the data/calibration_X/ folders alongside your bag files.

    PDF Reports: Check these for "Reprojection Error". (Goal: < 1.0 pixel).

    YAML Files: These contain the final parameters needed for VINS-Fusion or OpenVINS.
